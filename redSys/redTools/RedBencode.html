<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title></title>
<meta name="Generator" content="Cocoa HTML Writer">
<meta name="CocoaVersion" content="1187.34">
<style type="text/css">
p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; color: #0433ff}
p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #000000}
p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #737373}
p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #cd1c00}
p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #000000; min-height: 12.0px}
p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #0326cb}
span.s1 {font: 18.0px Helvetica}
span.s2 {text-decoration: underline ; color: #000000}
span.s3 {text-decoration: underline ; color: #cd1c00}
span.s4 {color: #0433ff}
span.s5 {color: #000000}
span.s6 {font: 12.0px Helvetica; color: #000000}
span.s7 {color: #737373}
span.s8 {color: #0326cb}
span.s9 {color: #008300}
span.s10 {color: #cd1c00}
span.s11 {color: #434ccb}
span.s12 {color: #ff7c00}
span.Apple-tab-span {white-space:pre}
</style>
</head>
<body>
<p class="p1"><span class="s1"><b>RedBencode</b></span><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>bencode encoder and decoder</b></p>
<p class="p2"><br></p>
<p class="p1">Read about this format here... <span class="s2">http:</span><span class="s3">//en.wikipedia.org/wiki/Bencode</span></p>
<p class="p2"><br></p>
<p class="p1">see also: <a href="../HelpSource/Classes/RedBase64.schelp"><span class="s4">RedBase64</span></a></p>
<p class="p2"><br></p>
<p class="p1"><b><span class="Apple-tab-span">	</span>*encode</b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Encodes an array of items as a bencoded string.</p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Expects an <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Array.html"><span class="s4">Array</span></a> with items of the following kind...</p>
<p class="p3"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Math/Integer.html">Integer</a></span></p>
<p class="p3"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/String.html">String</a></span></p>
<p class="p1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Array.html"><span class="s4">Array</span></a> (or <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/List.html"><span class="s4">List</span></a> etc.)</p>
<p class="p3"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Dictionary.html">Dictionary</a> (or <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Event.html">Event</a> etc.)</span></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>For example here is a valid argument with different items...</p>
<p class="p4"><span class="s6"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></span>[<span class="s7">"test"</span>, 4766, [555, [24, -50]], 40000, <span class="s8">Dictionary</span>[<span class="s9">\one</span>-&gt;111, <span class="s9">\two</span>-&gt;222]]</p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Returns a string containing the encoded data. For example...</p>
<p class="p5"><span class="s6"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></span>"4:testi4766eli555eli24ei-50eeei40000ed3:onei111e3:twoi222ee"</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p1"><b><span class="Apple-tab-span">	</span>*encodeBytes</b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Same as <b>*encode</b> but returns an array with 8bit bytes suitable for sending over serial port.</p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Returns an <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Int8Array.html"><span class="s4">Int8Array</span></a> containing the encoded data as 8bit bytes. For example...</p>
<p class="p4"><span class="s6"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></span><span class="s8">Int8Array</span>[52, 58, 116, 101, 115, 116, 105, 52, 55, 54, 54, 101, 108, 105, 53, 53, 53, 101, 108, 105, 50, 52, 101, 105, 45, 53, 48, 101, 101, 101, 105, 52, 48, 48, 48, 48, 101, 100, 51, 58, 111, 110, 101, 105, 49, 49, 49, 101, 51, 58, 116, 119, 111, 105, 50, 50, 50, 101, 101]</p>
<p class="p2"><span class="Apple-tab-span">	</span></p>
<p class="p1"><span class="Apple-tab-span">	</span><b>*decodeBytes</b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Same as <b>*decode</b> but useful when decoding data received from the serial port.</p>
<p class="p1"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Expects an <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Int8Array.html"><span class="s4">Int8Array</span></a> with 8bit values.</p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span>*decodeString</b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Same as <b>*decode</b> but takes a String as argument. This is the more common method for decoding (compare <b>*decode</b> and <b>*decodeBytes</b>).</p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span>*decode</b></p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Decodes a bencoded stream of characters in to an array of items (<a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Math/Integer.html"><span class="s4">Integer</span></a>, <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/String.html"><span class="s4">String</span></a>, <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Array.html"><span class="s4">Array</span></a>, <a href="../../../../../../../../Applications/SuperCollider357/SuperCollider.app/Contents/Resources/Help/Collections/Dictionary.html"><span class="s4">Dictionary</span></a>). Usually it is easier to use the <b>*decodeString</b> method as it will automatically create a CollStream out of the argument string.</p>
<p class="p1"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Note that Event will become Dictionary and List will become Array.</p>
<p class="p2"><b></b><br></p>
<p class="p6">//--examples</p>
<p class="p7"><br></p>
<p class="p6">//some items in an array to be encoded</p>
<p class="p4">a= [<span class="s7">"test"</span>, 4766, [555, [24, -50]], 40000, <span class="s8">Dictionary</span>[<span class="s9">\one</span>-&gt;111, <span class="s9">\two</span>-&gt;222]];</p>
<p class="p6">//encode</p>
<p class="p4">b= <span class="s8">RedBencode</span>.encode(a);</p>
<p class="p6"><span class="s5">b</span>//this is now the bencode string</p>
<p class="p7"><br></p>
<p class="p6">//decode</p>
<p class="p4">c= <span class="s8">RedBencode</span>.decodeString(b);</p>
<p class="p6"><span class="s5">a==c</span>//convert back - should be the same array as above</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p6">//--arduino real world test reading bencoded data from the serial port</p>
<p class="p6">//upload the serialSend example from https://github.com/jcw/embencode to an arduino</p>
<p class="p4">(</p>
<p class="p5"><span class="s4">var</span><span class="s5"> port= </span><span class="s8">SerialPort</span><span class="s5">(</span>"/dev/tty.usbmodemfa131"<span class="s5">, 57600);</span><span class="s10">//modify this port name</span></p>
<p class="p4"><span class="s8">CmdPeriod</span>.doOnce({port.close});</p>
<p class="p8">Routine<span class="s5">.run({</span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s4">var</span> lastByte= -1, stream;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s11">inf</span>.do{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s4">var</span> byte;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>while({byte= port.read; byte.notNil}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(byte==10 and:{lastByte==13}, {</p>
<p class="p6"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(stream.notNil, {</span>//skip the initial "\n[serialSend]"</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.pos= 0;</p>
<p class="p6"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></span><span class="s8">RedBencode</span><span class="s5">.decode(stream).postln;</span>//should post the result every 3sec</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream= <span class="s8">CollStream</span>.new;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>lastByte= -1;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(lastByte!= -1, {</p>
<p class="p6"><span class="s5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(stream.notNil, {</span>//skip the initial "\n[serialSend]"</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.put(lastByte.asAscii);</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>lastByte= byte;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span>};</p>
<p class="p4">});</p>
<p class="p4">)</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p6">//--arduino real world test sending bencoded data to the serial port</p>
<p class="p6">//upload the serialReceive example from https://github.com/jcw/embencode to an arduino</p>
<p class="p4">(</p>
<p class="p5"><span class="s4">var</span><span class="s5"> port= </span><span class="s8">SerialPort</span><span class="s5">(</span>"/dev/tty.usbmodemfa131"<span class="s5">, 57600);</span><span class="s10">//modify this port name</span></p>
<p class="p4"><span class="s8">CmdPeriod</span>.doOnce({port.close});</p>
<p class="p8">Routine<span class="s5">.run({</span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s4">var</span> lastByte= -1, stream= <span class="s8">CollStream</span>.new;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s11">inf</span>.do{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s4">var</span> byte;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>while({byte= port.read; byte.notNil}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(byte==10 and:{lastByte==13}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.contents.postln;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream= <span class="s8">CollStream</span>.new;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>lastByte= -1;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(lastByte!= -1, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.put(byte.asAscii);</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>lastByte= byte;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p7"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p4"><span class="Apple-tab-span">	</span>};</p>
<p class="p4">});</p>
<p class="p8">Routine<span class="s5">.run({</span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s4">var</span> arr;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s11">inf</span>.do{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>3.wait;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>arr= <span class="s8">RedBencode</span>.encodeBytes([<span class="s7">"abcde"</span>, <span class="s7">"123"</span>, 12345, [987, [654], 321], 999999999, <span class="s8">Dictionary</span>[<span class="s9">\one</span>-&gt;11, <span class="s9">\two</span>-&gt;22], <span class="s7">"bye!"</span>]);</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>port.putAll(arr);</p>
<p class="p4"><span class="Apple-tab-span">	</span>};</p>
<p class="p4">});</p>
<p class="p4">)</p>
<p class="p7"><br></p>
<p class="p7"><br></p>
<p class="p6">//--arduino real world test</p>
<p class="p6">//upload the blinky example from https://github.com/jcw/embencode to an arduino</p>
<p class="p4">(</p>
<p class="p5"><span class="s12">~port</span><span class="s5">= </span><span class="s8">SerialPort</span><span class="s5">(</span>"/dev/tty.usbmodemfa131"<span class="s5">, 57600);</span><span class="s10">//modify this port name</span></p>
<p class="p4"><span class="s8">CmdPeriod</span>.doOnce({<span class="s12">~port</span>.close});</p>
<p class="p8">Routine<span class="s5">.run({</span></p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s4">var</span> stream= <span class="s8">CollStream</span>.new;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="s11">inf</span>.do{</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s4">var</span> byte;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>while({byte= <span class="s12">~port</span>.next; byte.notNil}, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.put(byte.asAscii);</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>if(stream.pos&gt;0, {</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream.pos= 0;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="s8">RedBencode</span>.decode(stream).postln;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>stream= <span class="s8">CollStream</span>.new;</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>});</p>
<p class="p4"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>0.01.wait;</p>
<p class="p4"><span class="Apple-tab-span">	</span>};</p>
<p class="p4">});</p>
<p class="p4">)</p>
<p class="p7"><br></p>
<p class="p4"><span class="s12">~port</span>.putAll(<span class="s8">RedBencode</span>.encode([[<span class="s7">"rate"</span>, 250], [<span class="s7">"trigger"</span>, 4], [<span class="s7">"count"</span>, 10]]));</p>
<p class="p4"><span class="s12">~port</span>.putAll(<span class="s8">RedBencode</span>.encode([[<span class="s7">"rate"</span>, 100], [<span class="s7">"trigger"</span>, 10], [<span class="s7">"count"</span>, 20]]));</p>
</body>
</html>
